name: CI/CD Express + React (Taller Oficial)

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  # ==========================================
  # 1. INTEGRACIÓN CONTINUA (CI)
  # ==========================================
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          # Verifica que estas rutas coincidan con tus carpetas
          cache-dependency-path: |
            frontend/package-lock.json
            backend/package-lock.json

      - name: Instalar y Verificar Backend
        run: |
          cd backend
          npm install
          npm run lint || echo "No lint script"
          npm run test || echo "No test script"

      - name: Instalar y Construir Frontend
        run: |
          cd frontend
          npm install
          npm run build
        env:
          CI: false

      - name: Guardar Artefacto del Frontend
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/build

  # ==========================================
  # 2. DESPLIEGUE FRONTEND (GitHub Pages)
  # ==========================================
  deploy_frontend:
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Descargar Build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/build
      - name: Deploy a GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: frontend/build
          branch: gh-pages

  # ==========================================
  # 3. DESPLIEGUE BACKEND (Docker Hub)
  # ==========================================
  build_and_push_backend:
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Login en Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Construir y Subir Imagen
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/backend-express-ci-cd:latest